import{A as S,c as j}from"./config.BSXzPuxh.js";import"./AdminLayout.astro_astro_type_script_index_0_lang.DLKx8HaD.js";async function w(s,n={}){const i=localStorage.getItem("token");console.log("Token obtenido:",i?"Token presente":"Token ausente");const m={"Content-Type":"application/json",...n.headers};i?(m.Authorization=`Bearer ${i}`,console.log("Cabecera de autorización añadida")):console.warn("No se encontró token de autenticación"),console.log(`Realizando petición a: ${S}${s}`);try{const d=await fetch(`${S}${s}`,{...n,...j,headers:{...j.headers,...m}});return console.log(`Respuesta recibida: ${d.status} ${d.statusText}`),d.status===401?(console.error("Error 401: No autorizado"),localStorage.removeItem("isLoggedIn"),localStorage.removeItem("nombreUsuario"),localStorage.removeItem("token"),localStorage.removeItem("userId"),localStorage.removeItem("role"),window.location.href="/login",null):d}catch(d){throw console.error("Error en la petición:",d),d}}async function A(s){const n=await w(s);if(!n)return null;if(!n.ok)throw new Error(`Error al obtener datos: ${n.statusText}`);return await n.json()}async function q(s,n){const i=await w(s,{method:"POST",body:JSON.stringify(n)});if(!i)return null;if(!i.ok)throw new Error(`Error al enviar datos: ${i.statusText}`);return await i.json()}async function H(s,n){const i=await w(s,{method:"PUT",body:JSON.stringify(n)});if(!i)return null;if(!i.ok)throw new Error(`Error al actualizar datos: ${i.statusText}`);return await i.json()}async function V(s){const n=await w(s,{method:"DELETE"});if(!n)return null;if(!n.ok&&n.status!==204)throw new Error(`Error al eliminar datos: ${n.statusText}`);return!0}document.addEventListener("DOMContentLoaded",()=>{const s=localStorage.getItem("isLoggedIn"),n=localStorage.getItem("token");if(console.log("Catálogo Index - Estado de autenticación:",s),console.log("Catálogo Index - Token:",n?"Token presente":"Token ausente"),!s||s!=="true"||!n){console.warn("Usuario no autenticado o token ausente, redirigiendo al login"),window.location.href="/login";return}const i=document.getElementById("btnNuevoProducto"),m=document.getElementById("formProducto"),d=document.getElementById("formTitle"),E=document.getElementById("productoForm"),F=document.getElementById("btnCancelar"),P=document.getElementById("tablaProductos"),v=document.getElementById("productoId"),$=document.getElementById("buscador"),z=document.getElementById("btnBuscar"),p=document.getElementById("imagePreviewContainer"),c=document.getElementById("imagePreview"),T=document.getElementById("imageFileInput"),l=document.getElementById("dragText"),C=document.getElementById("imagen");let u=null,r=[];async function L(){try{r=await A("/productos"),f(r)}catch(a){console.error("Error:",a),r=JSON.parse(localStorage.getItem("productos"))||[],r.length===0&&(r=[{id:1,nombre:"Martillo Profesional",precio:24.99,stock:50,categoria:"herramientas",caracteristicas:"Mango ergonómico; Cabeza de acero forjado; Peso: 500g; Longitud: 30cm",descripcion:"Martillo profesional con mango ergonómico para mayor comodidad. Ideal para trabajos de construcción y carpintería.",imagen:"/Martillo.png",fecha_creacion:new Date().toISOString()},{id:2,nombre:"Sierra Circular",precio:129.99,stock:15,categoria:"herramientas",caracteristicas:"Potencia: 1200W; Velocidad: 5000 RPM; Diámetro de disco: 185mm; Profundidad de corte: 65mm",descripcion:"Sierra circular potente y precisa para cortes en madera, plástico y aluminio. Incluye guía paralela y disco de corte.",imagen:"/broca.png",fecha_creacion:new Date().toISOString()},{id:3,nombre:"Taladro Inalámbrico",precio:89.99,stock:25,categoria:"herramientas",caracteristicas:"Batería: 18V Li-Ion; Velocidad: 0-1500 RPM; Torque: 50Nm; Incluye 2 baterías",descripcion:"Taladro inalámbrico potente y versátil para todo tipo de perforaciones. Incluye maletín, cargador y 2 baterías.",imagen:"/flexo.jpg",fecha_creacion:new Date().toISOString()}],localStorage.setItem("productos",JSON.stringify(r))),f(r)}}function f(a=r){P.innerHTML="",a.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <img src="${e.imagen}" alt="${e.nombre}" class="h-10 w-10 rounded-full">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${e.nombre}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${e.precio.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.stock}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-${D(e.categoria)}-100 text-${D(e.categoria)}-800">
                            ${N(e.categoria)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${e.id}" class="btn-editar text-blue-600 hover:text-blue-900 mr-3">Editar</button>
                        <button data-id="${e.id}" class="btn-eliminar text-red-600 hover:text-red-900">Eliminar</button>
                    </td>
                `,P.appendChild(t)}),document.querySelectorAll(".btn-editar").forEach(e=>{e.addEventListener("click",J)}),document.querySelectorAll(".btn-eliminar").forEach(e=>{e.addEventListener("click",U)})}function D(a){return{herramientas:"blue",construccion:"yellow",jardineria:"green",electricidad:"purple",plomeria:"red"}[a]||"gray"}function N(a){return{herramientas:"Herramientas",construccion:"Construcción",jardineria:"Jardinería",electricidad:"Electricidad",plomeria:"Plomería"}[a]||a}i.addEventListener("click",()=>{d.textContent="Nuevo Producto",E.reset(),v.value="",m.classList.remove("hidden"),c.classList.add("hidden"),l.classList.remove("hidden"),u=null,C.value=""}),p.addEventListener("click",()=>{T.click()}),T.addEventListener("change",a=>{const e=a.target.files[0];if(e){const t=new FileReader;t.onload=o=>{u=o.target.result,c.src=u,c.classList.remove("hidden"),l.classList.add("hidden")},t.readAsDataURL(e)}}),["dragenter","dragover","dragleave","drop"].forEach(a=>{p.addEventListener(a,e=>{e.preventDefault(),e.stopPropagation()})}),p.addEventListener("dragenter",()=>{p.classList.add("border-blue-500")}),p.addEventListener("dragleave",()=>{p.classList.remove("border-blue-500")}),p.addEventListener("drop",a=>{p.classList.remove("border-blue-500");const e=a.dataTransfer.files[0];if(e&&e.type.startsWith("image/")){const t=new FileReader;t.onload=o=>{u=o.target.result,c.src=u,c.classList.remove("hidden"),l.classList.add("hidden")},t.readAsDataURL(e)}}),F.addEventListener("click",()=>{m.classList.add("hidden"),E.reset(),c.classList.add("hidden"),l.classList.remove("hidden"),u=null,C.value=""});async function J(a){const e=parseInt(a.target.dataset.id);try{const t=await A(`/productos/${e}`);d.textContent="Editar Producto",v.value=t.id,document.getElementById("nombre").value=t.nombre,document.getElementById("precio").value=t.precio,document.getElementById("stock").value=t.stock,document.getElementById("categoria").value=t.categoria,document.getElementById("caracteristicas").value=t.caracteristicas,document.getElementById("descripcion").value=t.descripcion,document.getElementById("imagen").value=t.imagen,t.imagen?(c.src=t.imagen,c.classList.remove("hidden"),l.classList.add("hidden")):(c.classList.add("hidden"),l.classList.remove("hidden")),m.classList.remove("hidden")}catch(t){console.error("Error:",t);const o=r.find(I=>I.id===e);o&&(d.textContent="Editar Producto",v.value=o.id,document.getElementById("nombre").value=o.nombre,document.getElementById("precio").value=o.precio,document.getElementById("stock").value=o.stock,document.getElementById("categoria").value=o.categoria,document.getElementById("caracteristicas").value=o.caracteristicas,document.getElementById("descripcion").value=o.descripcion,document.getElementById("imagen").value=o.imagen,o.imagen?(c.src=o.imagen,c.classList.remove("hidden"),l.classList.add("hidden")):(c.classList.add("hidden"),l.classList.remove("hidden")),m.classList.remove("hidden"))}}async function U(a){const e=parseInt(a.target.dataset.id);if(confirm("¿Está seguro de eliminar este producto?"))try{await V(`/productos/${e}`),L()}catch(t){console.error("Error:",t),r=r.filter(o=>o.id!==e),localStorage.setItem("productos",JSON.stringify(r)),f()}}z.addEventListener("click",O),$.addEventListener("keyup",a=>{a.key==="Enter"&&O()});function O(){const a=$.value.toLowerCase().trim();if(a===""){f();return}const e=r.filter(t=>t.nombre.toLowerCase().includes(a)||t.descripcion.toLowerCase().includes(a)||t.caracteristicas.toLowerCase().includes(a)||N(t.categoria).toLowerCase().includes(a));f(e)}E.addEventListener("submit",async a=>{a.preventDefault();const e=v.value?parseInt(v.value):null,t=document.getElementById("nombre").value,o=parseFloat(document.getElementById("precio").value),I=parseInt(document.getElementById("stock").value),x=document.getElementById("categoria").value,B=document.getElementById("caracteristicas").value,k=document.getElementById("descripcion").value;let h=document.getElementById("imagen").value;try{if(u)try{const y=new FormData;y.append("image_data",u);const M=localStorage.getItem("token"),_=M?{Authorization:`Bearer ${M}`}:{},R=await fetch(`${S}/upload-image-base64`,{method:"POST",credentials:"include",mode:"cors",headers:_,body:y});if(!R.ok)throw new Error("Error al subir la imagen");h=(await R.json()).url}catch(y){console.error("Error al subir imagen:",y),alert("Error al subir la imagen. Se usará la URL actual si existe.")}h||(h="/Martillo.png");const b={nombre:t,precio:o,stock:I,categoria:x,caracteristicas:B,descripcion:k,imagen:h};let g;if(e?g=await H(`/productos/${e}`,b):g=await q("/productos",b),!g)throw new Error("Error al guardar el producto");alert(e?"Producto actualizado correctamente":"Producto creado correctamente"),L(),m.classList.add("hidden"),E.reset(),c.classList.add("hidden"),l.classList.remove("hidden"),u=null}catch(b){if(console.error("Error:",b),alert(`Error: ${b.message}`),e){const g=r.findIndex(y=>y.id===e);g!==-1&&(r[g]={...r[g],nombre:t,precio:o,stock:I,categoria:x,caracteristicas:B,descripcion:k,imagen:h})}else{const g=r.length>0?Math.max(...r.map(y=>y.id))+1:1;r.push({id:g,nombre:t,precio:o,stock:I,categoria:x,caracteristicas:B,descripcion:k,imagen:h,fecha_creacion:new Date().toISOString()})}localStorage.setItem("productos",JSON.stringify(r)),f(),m.classList.add("hidden"),E.reset(),c.classList.add("hidden"),l.classList.remove("hidden"),u=null}}),L()});
